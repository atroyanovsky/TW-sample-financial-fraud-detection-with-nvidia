apiVersion: kubeflow.org/v1
kind: Notebook
metadata:
  name: fraud-detection-demo
  namespace: team-1
  labels:
    app: fraud-detection-demo
spec:
  template:
    spec:
      serviceAccountName: default-editor
      containers:
      - name: notebook
        image: kubeflownotebookswg/jupyter-pytorch-cuda:v1.9.2
        resources:
          requests:
            cpu: "1"
            memory: "4Gi"
          limits:
            cpu: "2"
            memory: "8Gi"
        env:
        - name: NB_PREFIX
          value: /notebook/team-1/fraud-detection-demo
        - name: KF_PIPELINES_SA_TOKEN_PATH
          value: /var/run/secrets/kubeflow/pipelines/token
        volumeMounts:
        - name: workspace
          mountPath: /home/jovyan
        - mountPath: /var/run/secrets/kubeflow/pipelines
          name: volume-kf-pipeline-token
          readOnly: true
      volumes:
      - name: workspace
        persistentVolumeClaim:
          claimName: fraud-detection-demo-workspace
      - name: volume-kf-pipeline-token
        projected:
          sources:
            - serviceAccountToken:
                path: token
                expirationSeconds: 7200
                audience: pipelines.kubeflow.org
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: fraud-detection-demo-workspace
  namespace: team-1
spec:
  accessModes:
  - ReadWriteOnce
  storageClassName: gp3
  resources:
    requests:
      storage: 50Gi
---
apiVersion: batch/v1
kind: Job
metadata:
  name: git-clone-fraud-detection
  namespace: team-1
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: git-clone
        image: alpine/git:latest
        command: ["sh", "-c", "git clone https://github.com/aws-samples/sample-financial-fraud-detection-with-nvidia.git /workspace/fraud-detection && chown -R 1000:100 /workspace/fraud-detection"]
        volumeMounts:
        - name: workspace
          mountPath: /workspace
      volumes:
      - name: workspace
        persistentVolumeClaim:
          claimName: fraud-detection-demo-workspace
