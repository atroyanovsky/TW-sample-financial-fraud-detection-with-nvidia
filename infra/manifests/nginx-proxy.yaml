apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-proxy-config
  namespace: deploykf-istio-gateway
data:
  nginx.conf: |
    worker_processes 1;
    error_log /dev/stderr info;

    events {
      worker_connections 1024;
    }

    stream {
      upstream deploykf_gateway {
        server deploykf-gateway.deploykf-istio-gateway.svc.cluster.local:8443;
      }

      server {
        listen 8443;
        proxy_pass deploykf_gateway;
        proxy_connect_timeout 10s;
        proxy_timeout 300s;
      }
    }
---
apiVersion: v1
kind: Pod
metadata:
  name: nginx-proxy
  namespace: deploykf-istio-gateway
  labels:
    app: nginx-proxy
spec:
  containers:
  - name: nginx
    image: nginx:alpine
    ports:
    - containerPort: 8443
      name: https
    volumeMounts:
    - name: config
      mountPath: /etc/nginx/nginx.conf
      subPath: nginx.conf
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 100m
        memory: 128Mi
  volumes:
  - name: config
    configMap:
      name: nginx-proxy-config
